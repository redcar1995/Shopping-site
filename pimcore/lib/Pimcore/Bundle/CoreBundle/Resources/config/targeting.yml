services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false

    GeoIp2\ProviderInterface: '@GeoIp2\Database\Reader'
    GeoIp2\Database\Reader:
        arguments:
            $filename: '%pimcore.geoip.db_file%'

    Pimcore\Targeting\EventListener\TargetingListener: ~
    Pimcore\Targeting\EventListener\DocumentTargetGroupListener: ~

    #
    # TARGETING STORAGE
    #

    Pimcore\Targeting\Storage\TargetingStorageInterface: '@Pimcore\Targeting\Storage\RedisStorage'

    # Session
    Pimcore\Targeting\Storage\SessionStorage: ~

    # Cookie
    Pimcore\Targeting\Storage\Cookie\JsonCookieSaveHandler: ~
    Pimcore\Targeting\Storage\Cookie\JWTCookieSaveHandler:
        arguments:
            $secret: '%kernel.secret%'

    Pimcore\Targeting\Storage\CookieStorage:
        arguments:
            $saveHandler: '@Pimcore\Targeting\Storage\Cookie\JsonCookieSaveHandler'

    # Database
    Pimcore\Targeting\Storage\DbStorage: ~

    # Redis
    pimcore.targeting.storage.redis.connection:
        class: Credis_Client
        factory: [Pimcore\Storage\Redis\ConnectionFactory, createConnection]
        arguments:
            - { server: 127.0.0.1, database: 7 }

    Pimcore\Targeting\Storage\RedisStorage:
        arguments:
            $redis: '@pimcore.targeting.storage.redis.connection'

    # Example for fallback
    # Pimcore\Targeting\Storage\FallbackStorage:
    #    arguments:
    #        $primaryStorage: '@Pimcore\Targeting\Storage\DbStorage'
    #        $fallbackStorage: '@Pimcore\Targeting\Storage\CookieStorage'



    Pimcore\Targeting\VisitorInfoStorageInterface: '@Pimcore\Targeting\VisitorInfoStorage'
    Pimcore\Targeting\VisitorInfoStorage: ~

    Pimcore\Targeting\VisitorInfoResolver:
        lazy: true


    #
    # DATA PROVIDERS
    #

    Pimcore\Targeting\DataLoaderInterface: '@Pimcore\Targeting\DataLoader'
    Pimcore\Targeting\DataLoader: ~

    Pimcore\Targeting\DataProvider\GeoIp: ~
    Pimcore\Targeting\DataProvider\Device:
        arguments:
            $cache: '@pimcore.cache.core.pool'

    Pimcore\Targeting\DataProvider\Piwik: ~
    Pimcore\Targeting\DataProvider\TargetingStorage: ~


    #
    # CONDITIONS
    #

    Pimcore\Targeting\ConditionFactoryInterface: '@Pimcore\Targeting\ConditionFactory'
    Pimcore\Targeting\ConditionFactory:
        arguments:
            $conditions: '%pimcore.targeting.conditions%'

    pimcore.targeting.condition_matcher.expression_language:
        class: Symfony\Component\ExpressionLanguage\ExpressionLanguage
        arguments:
            $cache: '@pimcore.cache.core.pool'

    Pimcore\Targeting\ConditionMatcherInterface: '@Pimcore\Targeting\ConditionMatcher'
    Pimcore\Targeting\ConditionMatcher:
        arguments:
            $expressionLanguage: '@pimcore.targeting.condition_matcher.expression_language'


    #
    # ACTION HANDLERS
    #

    Pimcore\Targeting\ActionHandler\ActionHandlerInterface: '@Pimcore\Targeting\ActionHandler\DelegatingActionHandler'
    Pimcore\Targeting\ActionHandler\DelegatingActionHandler: ~
    Pimcore\Targeting\ActionHandler\AssignTargetGroup: ~
    Pimcore\Targeting\ActionHandler\Redirect: ~
    Pimcore\Targeting\ActionHandler\CodeSnippet: ~

    Pimcore\Targeting\Session\SessionConfigurator:
        tags:
            - { name: pimcore.session.configurator }

    Pimcore\Targeting\Document\DocumentTargetingConfigurator: ~
